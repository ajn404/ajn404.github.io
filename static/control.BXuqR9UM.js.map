{"version":3,"file":"control.BXuqR9UM.js","sources":["../../src/components/react/cesium/reference/camera/control.tsx"],"sourcesContent":["import { useEffect, useRef, useState, useCallback } from \"react\";\nimport {\n  Viewer,\n  Ion,\n  ScreenSpaceEventHandler,\n  Cartesian3,\n  ScreenSpaceEventType,\n} from \"cesium\";\nimport \"cesium/Build/Cesium/Widgets/widgets.css\";\nimport { Button } from \"@components/react/shadcn/ui/button\";\nimport { Alert, AlertDescription } from \"@components/react/shadcn/ui/alert\";\nimport { RocketIcon } from \"@radix-ui/react-icons\";\nIon.defaultAccessToken =\n  \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwOWRkMzFlYS0yMDVhLTRkNzYtYWJmMC1hMmE1NjljN2MyNjMiLCJpZCI6NzMzNDQsImlhdCI6MTYzNjgxNDEzNX0.Q2MfD_lkQgsJ-R3NPfYjS9QA9q_j4Py8DktYKsPmZNg\";\n\nexport default function Control() {\n  const cesiumRef = useRef(null);\n  const viewerRef = useRef(null);\n  const scene = useRef(null);\n  let mousePosition = useRef(null);\n  let startMousePosition = useRef(null);\n\n  const [cameraControlEnabled, setCameraControlEnabled] = useState(true);\n  const flags = useRef({\n    looking: false,\n    moveForward: false,\n    moveBackward: false,\n    moveUp: false,\n    moveDown: false,\n    moveLeft: false,\n    moveRight: false,\n  });\n\n  const toggleCameraControl = useCallback(() => {\n    if (!scene.current) return;\n\n    const cameraController = scene.current.screenSpaceCameraController;\n    cameraController.enableRotate = !cameraControlEnabled;\n    cameraController.enableTranslate = !cameraControlEnabled;\n    cameraController.enableZoom = !cameraControlEnabled;\n    cameraController.enableTilt = !cameraControlEnabled;\n    cameraController.enableLook = !cameraControlEnabled;\n\n    setCameraControlEnabled(prev => !prev);\n  }, [cameraControlEnabled]);\n\n  useEffect(() => {\n    if (cesiumRef.current && !viewerRef.current) {\n      viewerRef.current = new Viewer(cesiumRef.current, {\n        terrainProvider: undefined,\n        baseLayerPicker: false,\n        geocoder: false,\n        homeButton: false,\n        sceneModePicker: false,\n        navigationHelpButton: false,\n        animation: false,\n        timeline: false,\n        fullscreenButton: false,\n      });\n      //@ts-ignore\n      viewerRef.current._cesiumWidget._creditContainer.parentNode.removeChild(\n        //@ts-ignore\n        viewerRef.current._cesiumWidget._creditContainer\n      );\n\n      scene.current = viewerRef.current.scene;\n      const canvas = viewerRef.current.canvas;\n      canvas.setAttribute(\"tabindex\", \"0\");\n      canvas.onclick = () => canvas.focus();\n\n      const handler = new ScreenSpaceEventHandler(canvas);\n      handler.setInputAction(movement => {\n        flags.current.looking = true;\n        mousePosition.current = Cartesian3.clone(movement.position);\n        startMousePosition.current = mousePosition.current;\n      }, ScreenSpaceEventType.LEFT_DOWN);\n\n      handler.setInputAction(movement => {\n        mousePosition.current = movement.endPosition;\n      }, ScreenSpaceEventType.MOUSE_MOVE);\n\n      handler.setInputAction(() => {\n        flags.current.looking = false;\n      }, ScreenSpaceEventType.LEFT_UP);\n\n      const getFlagForKeyCode = code => {\n        switch (code) {\n          case \"KeyW\":\n            return \"moveForward\";\n          case \"KeyS\":\n            return \"moveBackward\";\n          case \"KeyQ\":\n            return \"moveUp\";\n          case \"KeyE\":\n            return \"moveDown\";\n          case \"KeyD\":\n            return \"moveRight\";\n          case \"KeyA\":\n            return \"moveLeft\";\n          default:\n            return undefined;\n        }\n      };\n\n      document.addEventListener(\"keydown\", e => {\n        const flagName = getFlagForKeyCode(e.code);\n        if (flagName) {\n          flags.current[flagName] = true;\n        }\n      });\n\n      document.addEventListener(\"keyup\", e => {\n        const flagName = getFlagForKeyCode(e.code);\n        if (flagName) {\n          flags.current[flagName] = false;\n        }\n      });\n\n      const ellipsoid = scene.current.globe.ellipsoid;\n      viewerRef.current.clock.onTick.addEventListener(() => {\n        const camera = viewerRef.current.camera;\n        const width = canvas.clientWidth;\n        const height = canvas.clientHeight;\n\n        if (flags.current.looking) {\n          const x =\n            (mousePosition.current.x - startMousePosition.current.x) / width;\n          const y =\n            -(mousePosition.current.y - startMousePosition.current.y) / height;\n\n          const lookFactor = 0.05;\n          camera.lookRight(x * lookFactor);\n          camera.lookUp(y * lookFactor);\n        }\n\n        const cameraHeight = ellipsoid.cartesianToCartographic(\n          camera.position\n        ).height;\n        const moveRate = cameraHeight / 100.0;\n\n        if (flags.current.moveForward) camera.moveForward(moveRate);\n        if (flags.current.moveBackward) camera.moveBackward(moveRate);\n        if (flags.current.moveUp) camera.moveUp(moveRate);\n        if (flags.current.moveDown) camera.moveDown(moveRate);\n        if (flags.current.moveLeft) camera.moveLeft(moveRate);\n        if (flags.current.moveRight) camera.moveRight(moveRate);\n      });\n\n      const handleWheel = event => {\n        //阻止冒泡\n        event.stopPropagation();\n      };\n      cesiumRef.current.addEventListener(\"wheel\", handleWheel);\n\n      return () => {\n        viewerRef.current.destroy();\n        viewerRef.current = null;\n        document.removeEventListener(\"keydown\", () => {});\n        document.removeEventListener(\"keyup\", () => {});\n      };\n    }\n  }, []);\n\n  return (\n    <div>\n      <div\n        onDoubleClick={() => {\n          if (cesiumRef.current) {\n            if (document.fullscreenElement) {\n              document.exitFullscreen();\n            } else {\n              cesiumRef.current.requestFullscreen();\n            }\n          }\n        }}\n        ref={cesiumRef}\n        style={{ width: \"100%\", height: \"500px\", userSelect: \"none\" }}\n      />\n      <Button onClick={toggleCameraControl} className=\"mt-4\">\n        {`${cameraControlEnabled ? \"关闭\" : \"打开\"}原生相机控制`}\n      </Button>\n      {!cameraControlEnabled && (\n        <Alert className=\"mt-4\">\n          <RocketIcon className=\"h-4 w-4\" />\n          <AlertDescription>\n            <pre>试试使用qwe asd控制相机</pre>\n          </AlertDescription>\n        </Alert>\n      )}\n    </div>\n  );\n}\n"],"names":["Ion","Control","cesiumRef","useRef","viewerRef","scene","mousePosition","startMousePosition","cameraControlEnabled","setCameraControlEnabled","useState","flags","toggleCameraControl","useCallback","cameraController","prev","useEffect","Viewer","canvas","handler","ScreenSpaceEventHandler","movement","Cartesian3","ScreenSpaceEventType","getFlagForKeyCode","code","flagName","ellipsoid","camera","width","height","x","y","lookFactor","moveRate","handleWheel","event","jsx","Button","jsxs","Alert","RocketIcon","AlertDescription"],"mappings":"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"}