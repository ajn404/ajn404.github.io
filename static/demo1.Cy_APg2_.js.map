{"version":3,"file":"demo1.Cy_APg2_.js","sources":["../../src/components/react/fiber/bookOfShader/specific/demo1.tsx"],"sourcesContent":["import React, { useRef, useEffect, useState, useMemo } from \"react\";\nimport { Canvas, useFrame, useThree } from \"@react-three/fiber\";\nimport { ShaderMaterial } from \"three\";\nimport { Slider } from \"@components/react/shadcn/ui/slider\";\nimport { cn } from \"@utils/utils\";\nimport { useDebounce } from \"@uidotdev/usehooks\";\nimport * as THREE from \"three\";\n\nconst CustomShaderCube: React.FC<{\n  mouse: { x: number; y: number };\n  vertexShader: string;\n  fragmentShader: string;\n}> = ({ mouse, vertexShader, fragmentShader }) => {\n  const geometry = useMemo(() => new THREE.PlaneGeometry(2, 2), []);\n  const meshRef = useRef<THREE.Mesh>(null);\n  const { size, gl } = useThree();\n\n  const material = useMemo<ShaderMaterial>(() => {\n    return new ShaderMaterial({\n      vertexShader,\n      fragmentShader,\n      uniforms: {\n        u_time: { value: 0 },\n        u_resolution: { value: new THREE.Vector2() },\n        u_mouse: { value: new THREE.Vector2() },\n      },\n    });\n  }, [vertexShader, fragmentShader]);\n\n  useEffect(() => {\n    return () => {\n      material.dispose();\n      geometry.dispose();\n    };\n  }, [material, geometry]);\n\n  useEffect(() => {\n    const pixelRatio = window.devicePixelRatio || 2;\n    gl.setPixelRatio(pixelRatio);\n    gl.setSize(size.width, size.height);\n    material.uniforms.u_resolution.value.set(size.width, size.height);\n  }, [size.width, size.height, gl, material]);\n\n  useFrame(({ clock }) => {\n    material.uniforms.u_time.value = clock.getElapsedTime();\n    material.uniforms.u_mouse.value.set(mouse.x, mouse.y);\n  });\n\n  useEffect(() => {\n    const canvas = gl.domElement;\n\n    const handleContextLost = (event: Event) => {\n      event.preventDefault();\n      console.log(\"WebGL context lost. Attempting to restore...\");\n    };\n\n    const handleContextRestored = () => {\n      console.log(\"WebGL context restored\");\n      // 重新初始化必要的 WebGL 资源\n      gl.setPixelRatio(window.devicePixelRatio || 2);\n      gl.setSize(size.width, size.height);\n      material.uniforms.u_resolution.value.set(size.width, size.height);\n    };\n\n    canvas.addEventListener(\"webglcontextlost\", handleContextLost);\n    canvas.addEventListener(\"webglcontextrestored\", handleContextRestored);\n\n    return () => {\n      canvas.removeEventListener(\"webglcontextlost\", handleContextLost);\n      canvas.removeEventListener(\"webglcontextrestored\", handleContextRestored);\n    };\n  }, [gl, size, material]);\n\n  useEffect(() => {\n    if (meshRef.current) {\n      meshRef.current.position.z = 0;\n    }\n  }, []);\n\n  return <mesh ref={meshRef} material={material} geometry={geometry}></mesh>;\n};\n\ntype NumericString = `${number}`;\n\nconst App: React.FC<{\n  vertexShader?: string;\n  width?: NumericString;\n  height?: NumericString;\n}> = ({\n  vertexShader = `\n    uniform vec2 u_resolution;\n    varying vec2 v_uv;\n\n    void main() {\n      v_uv = (position.xy + 1.0) / 2.0; // Convert coordinates to [0, 1] range\n      gl_Position = vec4(position, 1.0);\n    }\n  `,\n  width = \"20\",\n  height = \"20\",\n}) => {\n  const [mouse, setMouse] = useState({ x: 0, y: 0 });\n  const canvas = useRef<HTMLCanvasElement>(null);\n  const [density, setDensity] = useState(10);\n  const debouncedDensity = useDebounce(density, 300); // 防抖延迟 300ms\n\n  useEffect(() => {\n    const handleMouseMove = (event: MouseEvent) => {\n      setMouse({ x: event.clientX, y: event.clientY });\n    };\n\n    canvas.current?.addEventListener(\"mousemove\", handleMouseMove);\n\n    return () => {\n      canvas.current?.removeEventListener(\"mousemove\", handleMouseMove);\n    };\n  }, []);\n\n  const fragmentShader = useMemo(() => {\n    return `\n      varying vec2 v_uv;\n      uniform vec2 u_resolution;\n\n      void main() {\n        vec2 st = v_uv;\n        st.x *= u_resolution.x / u_resolution.y;\n        vec3 color = vec3(0.0);\n        float d = 0.0;\n        st = st * 2.0 - 1.0;\n        d = length(abs(st) - 0.3);\n        gl_FragColor = vec4(vec3(fract(d * ${debouncedDensity}.)), 1.0);\n      }\n    `;\n  }, [debouncedDensity]);\n\n  return (\n    <div className=\"flex flex-col items-center justify-center my-4\">\n      <Canvas\n        dpr={[1, 2]}\n        className=\"m-auto\"\n        gl={{ antialias: false }}\n        camera={{ position: [0, 0, 15], fov: 17.5, near: 1, far: 20 }}\n        style={{ width: `${width}vw`, height: `${height}vw` }}\n        ref={canvas}\n      >\n        <color attach=\"background\" args={[\"black\"]} />\n        <CustomShaderCube\n          mouse={mouse}\n          vertexShader={vertexShader}\n          fragmentShader={fragmentShader}\n        />\n      </Canvas>\n      <code>{`gl_FragColor = vec4(vec3(fract(d * ${debouncedDensity})), 1.0);`}</code>\n      <Slider\n        defaultValue={[30]}\n        max={100}\n        min={5}\n        step={1}\n        className={cn(\"w-[50%] m-4\")}\n        onValueChange={value => setDensity(value[0])}\n        value={[density]}\n      />\n    </div>\n  );\n};\n\nexport default App;\n"],"names":["CustomShaderCube","mouse","vertexShader","fragmentShader","geometry","useMemo","THREE.PlaneGeometry","meshRef","useRef","size","gl","useThree","material","ShaderMaterial","THREE.Vector2","useEffect","pixelRatio","useFrame","clock","canvas","handleContextLost","event","handleContextRestored","jsx","App","width","height","setMouse","useState","density","setDensity","debouncedDensity","useDebounce","handleMouseMove","jsxs","Canvas","Slider","cn","value"],"mappings":"g7BAQA,MAAMA,EAID,CAAC,CAAE,MAAAC,EAAO,aAAAC,EAAc,eAAAC,KAAqB,CAC1C,MAAAC,EAAWC,EAAAA,QAAQ,IAAM,IAAIC,EAAoB,EAAG,CAAC,EAAG,EAAE,EAC1DC,EAAUC,SAAmB,IAAI,EACjC,CAAE,KAAAC,EAAM,GAAAC,CAAG,EAAIC,EAAS,EAExBC,EAAWP,EAAAA,QAAwB,IAChC,IAAIQ,EAAe,CACxB,aAAAX,EACA,eAAAC,EACA,SAAU,CACR,OAAQ,CAAE,MAAO,CAAE,EACnB,aAAc,CAAE,MAAO,IAAIW,CAAgB,EAC3C,QAAS,CAAE,MAAO,IAAIA,CAAgB,CAAA,CACxC,CACD,EACA,CAACZ,EAAcC,CAAc,CAAC,EAEjCY,OAAAA,EAAAA,UAAU,IACD,IAAM,CACXH,EAAS,QAAQ,EACjBR,EAAS,QAAQ,CACnB,EACC,CAACQ,EAAUR,CAAQ,CAAC,EAEvBW,EAAAA,UAAU,IAAM,CACR,MAAAC,EAAa,OAAO,kBAAoB,EAC9CN,EAAG,cAAcM,CAAU,EAC3BN,EAAG,QAAQD,EAAK,MAAOA,EAAK,MAAM,EAClCG,EAAS,SAAS,aAAa,MAAM,IAAIH,EAAK,MAAOA,EAAK,MAAM,CAAA,EAC/D,CAACA,EAAK,MAAOA,EAAK,OAAQC,EAAIE,CAAQ,CAAC,EAEjCK,EAAA,CAAC,CAAE,MAAAC,KAAY,CACtBN,EAAS,SAAS,OAAO,MAAQM,EAAM,eAAe,EACtDN,EAAS,SAAS,QAAQ,MAAM,IAAIX,EAAM,EAAGA,EAAM,CAAC,CAAA,CACrD,EAEDc,EAAAA,UAAU,IAAM,CACd,MAAMI,EAAST,EAAG,WAEZU,EAAqBC,GAAiB,CAC1CA,EAAM,eAAe,EACrB,QAAQ,IAAI,8CAA8C,CAC5D,EAEMC,EAAwB,IAAM,CAClC,QAAQ,IAAI,wBAAwB,EAEjCZ,EAAA,cAAc,OAAO,kBAAoB,CAAC,EAC7CA,EAAG,QAAQD,EAAK,MAAOA,EAAK,MAAM,EAClCG,EAAS,SAAS,aAAa,MAAM,IAAIH,EAAK,MAAOA,EAAK,MAAM,CAClE,EAEO,OAAAU,EAAA,iBAAiB,mBAAoBC,CAAiB,EACtDD,EAAA,iBAAiB,uBAAwBG,CAAqB,EAE9D,IAAM,CACJH,EAAA,oBAAoB,mBAAoBC,CAAiB,EACzDD,EAAA,oBAAoB,uBAAwBG,CAAqB,CAC1E,CACC,EAAA,CAACZ,EAAID,EAAMG,CAAQ,CAAC,EAEvBG,EAAAA,UAAU,IAAM,CACVR,EAAQ,UACFA,EAAA,QAAQ,SAAS,EAAI,EAEjC,EAAG,EAAE,EAEGgB,EAAAA,IAAA,OAAA,CAAK,IAAKhB,EAAS,SAAAK,EAAoB,SAAAR,EAAoB,CACrE,EAIMoB,EAID,CAAC,CACJ,aAAAtB,EAAe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IASf,MAAAuB,EAAQ,KACR,OAAAC,EAAS,IACX,IAAM,CACE,KAAA,CAACzB,EAAO0B,CAAQ,EAAIC,EAAA,SAAS,CAAE,EAAG,EAAG,EAAG,EAAG,EAC3CT,EAASX,SAA0B,IAAI,EACvC,CAACqB,EAASC,CAAU,EAAIF,EAAAA,SAAS,EAAE,EACnCG,EAAmBC,EAAYH,EAAS,GAAG,EAEjDd,EAAAA,UAAU,IAAM,CACR,MAAAkB,EAAmBZ,GAAsB,CAC7CM,EAAS,CAAE,EAAGN,EAAM,QAAS,EAAGA,EAAM,QAAS,CACjD,EAEO,OAAAF,EAAA,SAAS,iBAAiB,YAAac,CAAe,EAEtD,IAAM,CACJd,EAAA,SAAS,oBAAoB,YAAac,CAAe,CAClE,CACF,EAAG,EAAE,EAEC,MAAA9B,EAAiBE,EAAAA,QAAQ,IACtB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6CAWkC0B,CAAgB;AAAA;AAAA,MAGxD,CAACA,CAAgB,CAAC,EAGnB,OAAAG,EAAA,KAAC,MAAI,CAAA,UAAU,iDACb,SAAA,CAAAA,EAAA,KAACC,EAAA,CACC,IAAK,CAAC,EAAG,CAAC,EACV,UAAU,SACV,GAAI,CAAE,UAAW,EAAM,EACvB,OAAQ,CAAE,SAAU,CAAC,EAAG,EAAG,EAAE,EAAG,IAAK,KAAM,KAAM,EAAG,IAAK,EAAG,EAC5D,MAAO,CAAE,MAAO,GAAGV,CAAK,KAAM,OAAQ,GAAGC,CAAM,IAAK,EACpD,IAAKP,EAEL,SAAA,CAAAI,EAAA,IAAC,SAAM,OAAO,aAAa,KAAM,CAAC,OAAO,EAAG,EAC5CA,EAAA,IAACvB,EAAA,CACC,MAAAC,EACA,aAAAC,EACA,eAAAC,CAAA,CAAA,CACF,CAAA,CACF,EACCoB,EAAA,IAAA,OAAA,CAAM,SAAsC,sCAAAQ,CAAgB,YAAY,EACzER,EAAA,IAACa,EAAA,CACC,aAAc,CAAC,EAAE,EACjB,IAAK,IACL,IAAK,EACL,KAAM,EACN,UAAWC,EAAG,aAAa,EAC3B,cAAeC,GAASR,EAAWQ,EAAM,CAAC,CAAC,EAC3C,MAAO,CAACT,CAAO,CAAA,CAAA,CACjB,EACF,CAEJ"}